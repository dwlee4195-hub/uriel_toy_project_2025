<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#3b82f6">
    <title>공항 감식팀 - 모바일</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'light-bg': '#ffffff',
                        'light-secondary': '#f8f9fa',
                        'light-tertiary': '#e9ecef',
                        'primary-blue': '#3b82f6',
                        'primary-green': '#10b981'
                    }
                }
            }
        }
    </script>
    
    <style>
        /* iOS 스타일 안전 영역 */
        .safe-top {
            padding-top: env(safe-area-inset-top);
        }
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* 부드러운 스크롤 */
        * {
            -webkit-overflow-scrolling: touch;
        }
        
        /* 탭 막대 높이 */
        .tab-bar {
            height: calc(56px + env(safe-area-inset-bottom));
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    
    <!-- 상단 헤더 -->
    <header class="bg-light-secondary border-b border-gray-200 fixed top-0 left-0 right-0 z-50 safe-top">
        <div class="px-4 py-3">
            <!-- 상단 줄 - 로고와 사용자 정보 -->
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center">
                    <img src="../Uriel_CI(png)/Uriel_logo.png" alt="Uriel" class="h-8 mr-3">
                    <div>
                        <h1 class="font-bold text-gray-900">공항 감식팀</h1>
                        <p class="text-xs text-gray-600">모바일 관제 시스템</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <!-- 알림 -->
                    <button class="relative p-2" onclick="showNotifications()">
                        <i class="fas fa-bell text-gray-600"></i>
                        <span id="notification-badge" class="absolute top-1 right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center font-bold text-xs">2</span>
                    </button>
                    <!-- 로그아웃 -->
                    <button onclick="logout()" class="p-2">
                        <i class="fas fa-sign-out-alt text-gray-600"></i>
                    </button>
                </div>
            </div>
            
            <!-- 하단 줄 - 사용자 정보 -->
            <div class="flex items-center justify-between bg-white rounded-lg px-3 py-2">
                <div class="flex items-center">
                    <div class="bg-primary-blue rounded-full w-8 h-8 flex items-center justify-center mr-2">
                        <i class="fas fa-user text-white text-sm"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-900" id="user-name">로딩중...</p>
                        <p class="text-xs text-gray-500" id="user-info">인증 확인중...</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-xs text-gray-500">현재 시각</p>
                    <p class="text-sm font-medium text-gray-900" id="current-time">00:00</p>
                </div>
            </div>
        </div>
    </header>
    
    <!-- 메인 콘텐츠 -->
    <main class="pt-32 pb-20 safe-top">
        <!-- 대시보드 카드들 -->
        <div class="p-4 space-y-4">
            
            <!-- 오늘의 업무 현황 -->
            <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
                <h2 class="font-bold text-gray-700 mb-3 flex items-center">
                    <i class="fas fa-calendar-day mr-2 text-primary-blue"></i>
                    오늘의 업무 현황
                </h2>
                <div class="grid grid-cols-2 gap-3">
                    <!-- 동적으로 업데이트됨 -->
                    <div class="text-center">
                        <p class="text-2xl font-bold text-gray-300">-</p>
                        <p class="text-xs text-gray-600">출동중</p>
                    </div>
                    <div class="text-center border-l border-gray-200">
                        <p class="text-2xl font-bold text-gray-300">-</p>
                        <p class="text-xs text-gray-600">완료</p>
                    </div>
                </div>
            </div>
            
            <!-- 배정된 업무 리스트 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100">
                <div class="p-4 border-b border-gray-100">
                    <h2 class="font-bold text-gray-700 flex items-center">
                        <i class="fas fa-tasks mr-2 text-primary-blue"></i>
                        배정된 업무
                    </h2>
                </div>
                <div class="divide-y divide-gray-100">
                    <!-- 동적으로 업데이트됨 -->
                    <div class="p-4 text-center text-gray-500">
                        <i class="fas fa-spinner fa-spin mb-2"></i>
                        <p class="text-sm">업무 목록 로딩중...</p>
                    </div>
                </div>
                
                <!-- 모두 보기 버튼 -->
                <div class="p-3 bg-gray-50">
                    <a href="tasks.html" class="text-primary-blue text-sm font-medium text-center block">
                        모든 업무 보기 <i class="fas fa-arrow-right ml-1"></i>
                    </a>
                </div>
            </div>

        </div>
    </main>
    
    <!-- 하단 탭 메뉴 -->
    <nav class="bg-white border-t border-gray-200 fixed bottom-0 left-0 right-0 z-50 tab-bar">
        <div class="grid grid-cols-4 h-14">
            <a href="index.html" class="flex flex-col items-center justify-center text-primary-blue">
                <i class="fas fa-home text-xl"></i>
                <span class="text-xs mt-1">홈</span>
            </a>
            <a href="tasks.html" class="flex flex-col items-center justify-center text-gray-600">
                <i class="fas fa-clipboard-list text-xl"></i>
                <span class="text-xs mt-1">업무</span>
            </a>
            <a href="map.html" class="flex flex-col items-center justify-center text-gray-600">
                <i class="fas fa-map-marked-alt text-xl"></i>
                <span class="text-xs mt-1">지도</span>
            </a>
            <a href="profile.html" class="flex flex-col items-center justify-center text-gray-600">
                <i class="fas fa-user text-xl"></i>
                <span class="text-xs mt-1">내정보</span>
            </a>
        </div>
    </nav>
    
    <!-- 알림 시스템 -->
    <script src="../js/notification.js"></script>
    
    <!-- 데이터 매니저 -->
    <script src="../js/data-manager.js"></script>
    
    <!-- 모바일 전용 스크립트 -->
    <script>
        // 로컬스토리지에서 업무 데이터 가져오기
        function getTasksData() {
            // incident-list와 동일한 데이터 소스 사용
            const incidents = localStorage.getItem('incidents');
            if (incidents) {
                return JSON.parse(incidents);
            }
            // fallback
            const storedData = localStorage.getItem('incidentsData');
            if (storedData) {
                return JSON.parse(storedData);
            }
            return [];
        }
        
        // 업무 현황 업데이트
        function updateTaskStatus() {
            const tasks = getTasksData();
            const currentUser = window.dataManager.getCurrentUser();
            
            console.log('전체 업무:', tasks.length);
            
            // 사용자 팀 정보 가져오기
            let userTeamData = null;
            if (currentUser && currentUser.teamId) {
                const teams = JSON.parse(localStorage.getItem('teams') || '[]');
                userTeamData = teams.find(t => t.id === currentUser.teamId);
            }
            
            // 오늘 날짜 필터링
            const today = new Date().toDateString();
            const todayTasks = tasks.filter(task => {
                const taskDate = new Date(task.detectedAt || task.timestamp || Date.now()).toDateString();
                const isToday = taskDate === today;
                
                // 오늘 업무 중에서 현재 팀과 관련된 업무만
                if (!isToday) return false;
                
                // 완료된 업무는 모든 팀 포함
                if (task.status === 'resolved') return true;
                
                // 진행중인 업무는 현재 팀에 배정된 것만
                return userTeamData && task.assignedTeam === userTeamData.id;
            });
            
            console.log('오늘 업무:', todayTasks.length);
            
            const assigned = todayTasks.filter(t => t.status === 'assigned' || t.status === 'in_progress').length;
            const completed = todayTasks.filter(t => t.status === 'resolved').length;
            
            console.log('배정된 업무:', assigned, '완료된 업무:', completed);
            
            // 오늘의 업무 현황 업데이트
            const statusHTML = `
                <div class="text-center">
                    <p class="text-2xl font-bold text-orange-500">${assigned}</p>
                    <p class="text-xs text-gray-600">출동중</p>
                </div>
                <div class="text-center">
                    <p class="text-2xl font-bold text-green-500">${completed}</p>
                    <p class="text-xs text-gray-600">완료</p>
                </div>
            `;
            
            const statusContainer = document.querySelector('.grid.grid-cols-2.gap-3');
            if (statusContainer) {
                statusContainer.innerHTML = statusHTML;
            }
            
            // 알림 배지 업데이트 (배정된 업무만 카운트)
            const notificationCount = assigned;
            const badge = document.getElementById('notification-badge');
            if (badge) {
                badge.textContent = notificationCount;
                badge.style.display = notificationCount > 0 ? 'flex' : 'none';
            }
        }
        
        // 배정된 업무 리스트 업데이트
        function updateTaskList() {
            const tasks = getTasksData();
            const currentUser = window.dataManager.getCurrentUser();
            
            // 사용자의 teamId로 팀 정보 찾기
            let userTeamData = null;
            if (currentUser && currentUser.teamId) {
                const teams = JSON.parse(localStorage.getItem('teams') || '[]');
                userTeamData = teams.find(t => t.id === currentUser.teamId);
            }
            
            const relevantTasks = tasks.filter(task => {
                // 배정된 업무만 (신규 제외)
                if (!task.assignedTeam) return false;
                // 사용자 팀에 배정된 업무만
                return userTeamData && task.assignedTeam === userTeamData.id;
            });
            
            const activeTasks = relevantTasks.filter(t => t.status !== 'resolved').slice(0, 2);
            
            let taskHTML = '';
            activeTasks.forEach(task => {
                let statusBadge = '';
                let statusText = '';
                
                switch(task.status) {
                    case 'pending':
                        statusBadge = 'bg-red-100 text-red-600';
                        statusText = '신규';
                        break;
                    case 'assigned':
                    case 'in_progress':
                        statusBadge = 'bg-orange-100 text-orange-600';
                        statusText = '출동중';
                        break;
                    default:
                        statusBadge = 'bg-gray-100 text-gray-600';
                        statusText = '미정';
                }
                
                const time = task.detectedAt ? 
                    new Date(task.detectedAt).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }) : 
                    '방금';
                
                const riskLevel = {
                    'high': '높음',
                    'medium': '중간',
                    'low': '낮음'
                }[task.riskLevel] || '중간';
                
                taskHTML += `
                    <a href="task-detail.html?id=${task.id}" class="block p-4 hover:bg-gray-50 transition-colors">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center mb-1">
                                    <span class="${statusBadge} text-xs px-2 py-1 rounded-full font-semibold">${statusText}</span>
                                    <span class="text-xs text-gray-500 ml-2">${time}</span>
                                </div>
                                <p class="font-medium text-gray-900">${task.location || 'T1-1F'} 수하물 확인</p>
                                <p class="text-sm text-gray-600 mt-1">${task.objectType || '미확인 물품'} - AI 위험도: ${riskLevel}</p>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </div>
                    </a>
                `;
            });
            
            const taskContainer = document.querySelector('.divide-y.divide-gray-100');
            if (taskContainer) {
                if (taskHTML) {
                    taskContainer.innerHTML = taskHTML;
                } else {
                    taskContainer.innerHTML = `
                        <div class="p-4 text-center text-gray-500">
                            <i class="fas fa-inbox text-2xl mb-2"></i>
                            <p class="text-sm">배정된 업무가 없습니다</p>
                        </div>
                    `;
                }
            }
        }

        // 페이지 로드 시 데이터 초기화
        function initializeData() {
            // incident-list와 동일한 데이터 구조 사용
            if (!window.dataManager) {
                console.error('DataManager not loaded');
                return;
            }
            
            // initializeDefaultData 메서드가 없을 수 있으므로 직접 체크
            if (typeof window.dataManager.initializeDefaultData === 'function') {
                window.dataManager.initializeDefaultData();
            } else {
                // 데이터가 없으면 기본 데이터 설정
                if (!localStorage.getItem('incidents')) {
                    console.log('Initializing default incidents data');
                    // 기본 데이터는 data-manager.js에서 처리
                }
            }
        }

        // 기존 스크립트 시작
        // 로그인 체크
        function checkAuth() {
            if (!window.dataManager || !window.dataManager.getCurrentUser()) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }
        
        // 사용자 정보 표시
        function displayUserInfo() {
            if (window.dataManager && window.dataManager.getCurrentUser) {
                const user = window.dataManager.getCurrentUser();
                if (user) {
                    document.getElementById('user-name').textContent = user.name;
                    
                    let roleLabel = '';
                    switch(user.role) {
                        case 'admin': roleLabel = '관리자'; break;
                        case 'supervisor': roleLabel = '감독관'; break;
                        case 'team_leader': roleLabel = '팀장'; break;
                        case 'team_member': roleLabel = '팀원'; break;
                        default: roleLabel = user.role;
                    }
                    
                    const department = user.department || '감식팀';
                    document.getElementById('user-info').textContent = `${department} - ${roleLabel}`;
                }
            }
        }
        
        // 로그아웃
        function logout() {
            if (window.dataManager && window.dataManager.logout) {
                window.dataManager.logout();
            }
            showSuccess('로그아웃되었습니다.');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 1000);
        }
        
        // 시계 업데이트
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ko-KR', { 
                hour: '2-digit', 
                minute: '2-digit'
            });
            document.getElementById('current-time').textContent = timeStr;
        }
        
        // 페이지 초기화
        window.addEventListener('DOMContentLoaded', function() {
            // 로그인 체크
            if (!checkAuth()) return;
            
            // 사용자 정보 표시
            displayUserInfo();
            
            // 데이터 초기화 및 로드를 약간 지연시켜 dataManager가 준비되도록 함
            setTimeout(() => {
                // 데이터 초기화
                initializeData();
                
                // 업무 데이터 업데이트
                updateTaskStatus();
                updateTaskList();
                
                // 5초마다 데이터 새로고침
                setInterval(() => {
                    updateTaskStatus();
                    updateTaskList();
                }, 5000);
            }, 100);
            
            // 시계 시작
            updateClock();
            setInterval(updateClock, 1000);
        });
        
        // 서비스 워커 등록 (PWA)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then(function(registration) {
                console.log('Service Worker 등록 성공:', registration);
            }).catch(function(error) {
                console.log('Service Worker 등록 실패:', error);
            });
        }
        
        // 긴급 배정 수락
        function acceptAssignment() {
            showSuccess('출동을 수락했습니다. 안전에 유의하세요!');
            document.getElementById('urgent-assignment').style.display = 'none';
            // 실제로는 서버에 수락 요청
        }
        
        // 긴급 배정 거절
        function rejectAssignment() {
            if (confirm('정말 거절하시겠습니까?')) {
                showWarning('출동을 거절했습니다.');
                document.getElementById('urgent-assignment').style.display = 'none';
                // 실제로는 서버에 거절 요청
            }
        }
        
        // 알림 보기
        function showNotifications() {
            window.location.href = 'notifications.html';
        }
        
        // 설정
        function showSettings() {
            window.location.href = 'settings.html';
        }
        
        // 푸시 알림 권한 요청
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    </script>
</body>
</html>